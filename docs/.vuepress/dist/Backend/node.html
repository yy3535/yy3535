<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>node | yy3535</title>
    <meta name="description" content="yy3535的笔记">
    <link rel="icon" href="/img/favicon.ico">
  <script src="/img/类图.png"></script>
    
    <link rel="preload" href="/assets/css/0.styles.21816eaa.css" as="style"><link rel="preload" href="/assets/js/app.50f8ab08.js" as="script"><link rel="preload" href="/assets/js/13.d2e67b08.js" as="script"><link rel="prefetch" href="/assets/js/10.3435ca1d.js"><link rel="prefetch" href="/assets/js/11.23c434f0.js"><link rel="prefetch" href="/assets/js/12.8a174cb5.js"><link rel="prefetch" href="/assets/js/14.04a411c6.js"><link rel="prefetch" href="/assets/js/15.83e03233.js"><link rel="prefetch" href="/assets/js/16.7b89664e.js"><link rel="prefetch" href="/assets/js/17.322814e5.js"><link rel="prefetch" href="/assets/js/18.f4a9f25c.js"><link rel="prefetch" href="/assets/js/19.03e74c86.js"><link rel="prefetch" href="/assets/js/2.867d5d8e.js"><link rel="prefetch" href="/assets/js/20.e0e76371.js"><link rel="prefetch" href="/assets/js/21.d21e094a.js"><link rel="prefetch" href="/assets/js/22.aa9aca84.js"><link rel="prefetch" href="/assets/js/23.19834df7.js"><link rel="prefetch" href="/assets/js/24.ed2f410a.js"><link rel="prefetch" href="/assets/js/25.223b5ff2.js"><link rel="prefetch" href="/assets/js/26.e586462e.js"><link rel="prefetch" href="/assets/js/27.d20152c5.js"><link rel="prefetch" href="/assets/js/28.d330b7e2.js"><link rel="prefetch" href="/assets/js/29.c900a6b0.js"><link rel="prefetch" href="/assets/js/3.02a75d06.js"><link rel="prefetch" href="/assets/js/30.af134b0c.js"><link rel="prefetch" href="/assets/js/31.60e11f00.js"><link rel="prefetch" href="/assets/js/32.dfdf0884.js"><link rel="prefetch" href="/assets/js/33.ab7ebf75.js"><link rel="prefetch" href="/assets/js/34.20a671cf.js"><link rel="prefetch" href="/assets/js/35.decc16bb.js"><link rel="prefetch" href="/assets/js/36.ea9369b1.js"><link rel="prefetch" href="/assets/js/37.03dc1006.js"><link rel="prefetch" href="/assets/js/38.eb39266c.js"><link rel="prefetch" href="/assets/js/39.b2f0fe35.js"><link rel="prefetch" href="/assets/js/4.b535f761.js"><link rel="prefetch" href="/assets/js/40.e184620e.js"><link rel="prefetch" href="/assets/js/41.584be5e5.js"><link rel="prefetch" href="/assets/js/42.3ab15439.js"><link rel="prefetch" href="/assets/js/43.dab423c9.js"><link rel="prefetch" href="/assets/js/44.d067a166.js"><link rel="prefetch" href="/assets/js/45.8b9bc0e4.js"><link rel="prefetch" href="/assets/js/46.ad24c826.js"><link rel="prefetch" href="/assets/js/47.b4f893b7.js"><link rel="prefetch" href="/assets/js/5.c4ab59e7.js"><link rel="prefetch" href="/assets/js/6.55a85baf.js"><link rel="prefetch" href="/assets/js/7.9f5e3965.js"><link rel="prefetch" href="/assets/js/8.557d9691.js"><link rel="prefetch" href="/assets/js/9.411314a2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.21816eaa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="yy3535" class="logo"> <span class="site-name can-hide">yy3535</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Frontend/" class="nav-link">前端</a></div><div class="nav-item"><a href="/Backend/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/Operation/" class="nav-link">运维</a></div><div class="nav-item"><a href="https://github.com/yy3535/yy3535" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Frontend/" class="nav-link">前端</a></div><div class="nav-item"><a href="/Backend/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/Operation/" class="nav-link">运维</a></div><div class="nav-item"><a href="https://github.com/yy3535/yy3535" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>后端</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Backend/node.html" class="active sidebar-link">node</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Backend/node.html#事件环-event-loop" class="sidebar-link">事件环(event loop)</a></li><li class="sidebar-sub-header"><a href="/Backend/node.html#node概况" class="sidebar-link">Node概况</a></li><li class="sidebar-sub-header"><a href="/Backend/node.html#node安装" class="sidebar-link">Node安装</a></li><li class="sidebar-sub-header"><a href="/Backend/node.html#node基础" class="sidebar-link">Node基础</a></li><li class="sidebar-sub-header"><a href="/Backend/node.html#node-module" class="sidebar-link">Node Module</a></li><li class="sidebar-sub-header"><a href="/Backend/node.html#node内置方法" class="sidebar-link">node内置方法</a></li><li class="sidebar-sub-header"><a href="/Backend/node.html#第三方模块" class="sidebar-link">第三方模块</a></li><li class="sidebar-sub-header"><a href="/Backend/node.html#模块查找流程" class="sidebar-link">模块查找流程</a></li><li class="sidebar-sub-header"><a href="/Backend/node.html#express" class="sidebar-link">express</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="node"><a href="#node" aria-hidden="true" class="header-anchor">#</a> node</h1> <p></p><div class="table-of-contents"><ul><li><a href="#事件环-event-loop">事件环(event loop)</a></li><li><a href="#node概况">Node概况</a><ul><li><a href="#定义">定义</a></li><li><a href="#单线程">单线程</a></li><li><a href="#浏览器模型">浏览器模型</a></li><li><a href="#node的event-loop">node的Event Loop</a></li><li><a href="#node作用">Node作用</a></li><li><a href="#node优点：">Node优点：</a></li><li><a href="#node缺点：">Node缺点：</a></li><li><a href="#什么场合用node框架">什么场合用Node框架</a></li></ul></li><li><a href="#node安装">Node安装</a></li><li><a href="#node基础">Node基础</a><ul><li><a href="#一些概念">一些概念</a></li><li><a href="#全局的属性">全局的属性</a></li><li><a href="#node事件环">node事件环</a></li></ul></li><li><a href="#node-module">Node Module</a><ul><li><a href="#模块化作用">模块化作用</a></li><li><a href="#node模块化类型">node模块化类型</a></li><li><a href="#定义模块">定义模块</a></li><li><a href="#引用模块">引用模块</a></li><li><a href="#导出模块">导出模块</a></li><li><a href="#模块化原理-闭包">模块化原理--闭包</a></li><li><a href="#require原理-加载js如何实现">require原理(加载js如何实现)</a></li><li><a href="#module-exports的两种写法">module.exports的两种写法</a></li></ul></li><li><a href="#node内置方法">node内置方法</a><ul><li><a href="#vm沙箱">vm沙箱</a></li><li><a href="#fs沙箱">fs沙箱</a></li><li><a href="#path-相对路径转绝对路径">path 相对路径转绝对路径</a></li><li><a href="#util工具方法">util工具方法</a></li><li><a href="#events-自定义事件">events 自定义事件</a></li><li><a href="#fs-文件">fs 文件</a></li><li><a href="#流">流</a></li></ul></li><li><a href="#第三方模块">第三方模块</a><ul><li><a href="#mz模块">mz模块</a></li><li><a href="#websocket">websocket</a></li></ul></li><li><a href="#模块查找流程">模块查找流程</a></li><li><a href="#express">express</a></li></ul></div><p></p> <h2 id="事件环-event-loop"><a href="#事件环-event-loop" aria-hidden="true" class="header-anchor">#</a> 事件环(event loop)</h2> <p>浏览器中，先调用主栈，主栈执行完成后，微任务放入微任务队列，宏任务放入宏任务队列（按执行顺序放入，setTimeout到时间了再放），执行完微任务，再取出宏任务队列中第一个执行，执行完后再次执行完微任务，再取第二个。</p> <p>————— 环</p> <p><img src="/img/%E4%BA%8B%E4%BB%B6%E7%8E%AF.png" alt="eventloop"></p> <ul><li><p>heap:堆，对象引用函数地址放在堆里</p></li> <li><p>stack:栈，代码执行放在栈里，后进先出</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//销毁顺序</span>
<span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>queue:队列，先进先出&lt;—— xxx &lt;——</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>线程</p> <ul><li>线程里包含着进程。</li></ul></li> <li><p>进程</p> <ul><li>计算机分配调度任务的最小单位。</li></ul></li> <li><p>js是单线程，也可以说是多线程(异步)</p></li> <li><p>then方法会比setTimeout等异步的等级更高一些，微任务会优先执行</p></li></ul> <p><strong>宏任务</strong>： <code>setTimeout</code> <code>setImmediate</code> <code>ie下使用 MessageChannel</code></p> <p><strong>微任务</strong>： <code>promise.then方法</code> <code>MutationObserver</code> <code>nextTick</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//定时器(只有ie支持，宏任务)</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//管道(宏任务)</span>
<span class="token keyword">let</span> channel<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> port1<span class="token operator">=</span>channel<span class="token punctuation">.</span>port1<span class="token punctuation">;</span>
<span class="token keyword">let</span> port2<span class="token operator">=</span>channel<span class="token punctuation">.</span>port2<span class="token punctuation">;</span>
port1<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
port2<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token comment">//hello</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 微任务</span>
<span class="token keyword">let</span> observer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'当前节点 已经更新完'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span><span class="token punctuation">{</span>
  childList<span class="token punctuation">:</span><span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="node概况"><a href="#node概况" aria-hidden="true" class="header-anchor">#</a> Node概况</h2> <h3 id="定义"><a href="#定义" aria-hidden="true" class="header-anchor">#</a> 定义</h3> <ul><li>node并不是JavaScript全集(es+dom+bom)，只是ecmascript+模块(服务端必备的方法)</li></ul> <h3 id="单线程"><a href="#单线程" aria-hidden="true" class="header-anchor">#</a> 单线程</h3> <ul><li><strong>webworker并不能改变单线程的本质</strong></li> <li>多线程单线程
<ul><li>多线程，锁的问题(多个线程修改同一个文件，需要先锁住文件，避免其他线程修改)</li> <li>多线程，看上去像同时做两件事，但其实只是这个干一点，那个干一点，再这个干一点。切换执行上下文是浪费时间的</li> <li>i/o密集型业务适合node，node单线程，并且通过事件驱动，完成后自动返回。不像别的是不断地要去询问，完成了吗
<img src="/img/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%8D%95%E7%BA%BF%E7%A8%8B.png" alt="屏幕快照 2019-04-06 21.46.45"></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//1.js</span>
<span class="token comment">//webworker,有任务，去通知别人做，主线程接着运算</span>
<span class="token comment">//不能操作dom</span>
<span class="token function-variable function">onmessage</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    sum<span class="token operator">+=</span>i<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">postMessage</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//1.html</span>
<span class="token keyword">let</span> worker<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./1.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'haha'</span><span class="token punctuation">)</span><span class="token comment">//</span>
</code></pre></div><h3 id="浏览器模型"><a href="#浏览器模型" aria-hidden="true" class="header-anchor">#</a> 浏览器模型</h3> <ul><li>我们的代码通过渲染引擎渲染，渲染引擎分为网络引擎，js引擎和css引擎，他们都是不能同时渲染的。都是一个线程。
<img src="/img/browser.jpg" alt="browser"></li></ul> <h3 id="node的event-loop"><a href="#node的event-loop" aria-hidden="true" class="header-anchor">#</a> node的Event Loop</h3> <ul><li>node里没有渲染引擎，只有node系统，功能就是让用户能实现异步。</li> <li>模块里的异步其实是通过模拟多线程实现的。
<img src="/img/nodesystem.png" alt="nodesystem"></li></ul> <h3 id="node作用"><a href="#node作用" aria-hidden="true" class="header-anchor">#</a> Node作用</h3> <ul><li>可用js编写服务端</li> <li>提高用户并发量，比传统的Java和Php高(java多线程)</li></ul> <h3 id="node优点："><a href="#node优点：" aria-hidden="true" class="header-anchor">#</a> Node优点：</h3> <ul><li><p>基于v8引擎，执行效率高，不高的地方用c写，c++模块扩展</p></li> <li><p>使用事件驱动，非阻塞式I/O模型</p></li> <li><p>npm包管理器，是全球最大的开源库生态系统</p> <ul><li>版本：npm install  --save  esri-loader@1</li></ul></li> <li><p>nvm node版本管理器</p> <div class="language-js extra-class"><pre class="language-js"><code>curl <span class="token operator">-</span>o<span class="token operator">-</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>nvm<span class="token operator">-</span>sh<span class="token operator">/</span>nvm<span class="token operator">/</span>v0<span class="token punctuation">.</span><span class="token number">34.0</span><span class="token operator">/</span>install<span class="token punctuation">.</span>sh <span class="token operator">|</span> bash
</code></pre></div><ul><li>使用</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 安装某个node版本 <span class="token operator">--</span><span class="token operator">&gt;</span>
nvm install <span class="token number">6.14</span><span class="token number">.4</span> # or <span class="token number">10.10</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">8.9</span><span class="token number">.1</span><span class="token punctuation">,</span> etc
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 列出已安装版本 <span class="token operator">--</span><span class="token operator">&gt;</span>
nvm ls<span class="token operator">-</span>remote
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 使用某个版本 <span class="token operator">--</span><span class="token operator">&gt;</span>
nvm use <span class="token number">8.9</span><span class="token number">.1</span>
</code></pre></div></li></ul> <h3 id="node缺点："><a href="#node缺点：" aria-hidden="true" class="header-anchor">#</a> Node缺点：</h3> <ul><li>脆，主线程挂了，就完蛋了</li></ul> <h3 id="什么场合用node框架"><a href="#什么场合用node框架" aria-hidden="true" class="header-anchor">#</a> 什么场合用Node框架</h3> <ul><li>不适合处理cpu密集的
<ul><li>聊天服务器(websocket)</li> <li>电子商务网站(静态服务，io读取)</li></ul></li></ul> <h2 id="node安装"><a href="#node安装" aria-hidden="true" class="header-anchor">#</a> Node安装</h2> <ul><li>本地：下载安装包直接安装，node -v npm -v(送包管理器)</li> <li>版本切换：mac nvm工具 win下 nvm-win</li></ul> <h2 id="node基础"><a href="#node基础" aria-hidden="true" class="header-anchor">#</a> Node基础</h2> <h3 id="一些概念"><a href="#一些概念" aria-hidden="true" class="header-anchor">#</a> 一些概念</h3> <ul><li>在浏览器中默认<code>this</code>指代<code>window</code>，在浏览器中<code>window</code>是代理了<code>global</code>属性，而文件中运行这个<code>this</code>不是<code>global</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//node.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//{}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span>
<span class="token comment">// Object[global]{</span>
<span class="token comment">//   ...</span>
<span class="token comment">//   global:[Circular],</span>
<span class="token comment">//   //进程</span>
<span class="token comment">//   process:</span>
<span class="token comment">//   	process { </span>

<span class="token comment">//     },</span>
<span class="token comment">//   //操作文件，需要二进制类型，就是Buffer,可以和字符串进行转换</span>
<span class="token comment">//   Buffer:</span>
<span class="token comment">//   clearImmediate setImmediate</span>
<span class="token comment">//   setTimeout clearTimeout</span>
<span class="token comment">//   ...</span>
<span class="token comment">// }</span>

<span class="token comment">//把对象展示成详细的</span>
console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>REPL read evaluate print loop 循环求值打印</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//进入node环境</span>
node
<span class="token comment">//打印出global的内容</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="全局的属性"><a href="#全局的属性" aria-hidden="true" class="header-anchor">#</a> 全局的属性</h3> <ul><li>console</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//1 标准输出</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">)</span> 
process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'呵呵'</span><span class="token punctuation">)</span>
<span class="token comment">//2 错误输出</span>
console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'warn'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'错误'</span><span class="token punctuation">)</span>
<span class="token comment">// 监控输出类型</span>
process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//0 表示标准输入</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>process</p> <ul><li><p>process.pid//进程id</p></li> <li><p>process.exit()//手动退出应用</p></li> <li><p>process.cwd()//current working directory 当前工作目录</p></li> <li><p>process.chdir('6.node')//改变当前工作目录</p></li> <li><p>process.nextTick(()=&gt;{//是node中唯一一个微任务
​	console.log('nextTick');
})</p></li> <li><p>process 环境变量 env 参数 argv：webpack definePlugin原理就是通过这个实现(process.env.NODE_ENV)</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//yargs把执行命令的时候传递参数解析成对象，可以自己手动将其变成对象</span>
<span class="token keyword">let</span> args<span class="token operator">=</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
args<span class="token operator">=</span>args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">total<span class="token punctuation">,</span>value<span class="token punctuation">,</span>currentIndex<span class="token punctuation">,</span>arr</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    total<span class="token punctuation">[</span>value<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span>arr<span class="token punctuation">[</span>currentIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> total<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>p<span class="token punctuation">)</span>
</code></pre></div></li></ul> <h3 id="node事件环"><a href="#node事件环" aria-hidden="true" class="header-anchor">#</a> node事件环</h3> <ul><li>node中有如下六个队列，依次执行。</li> <li>每次都把队列清空后，或者达到执行的最大限制切换到下一个队列中会再执行微任务</li></ul> <p><img src="/img/node%E4%BA%8B%E4%BB%B6%E7%8E%AF.png" alt="node事件环"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 面试题</span>
<span class="token keyword">let</span> fs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//poll阶段下一个阶段是check,所以执行的话一定是走的setImmidaite</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'note.md'</span><span class="token punctuation">,</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate2'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="node-module"><a href="#node-module" aria-hidden="true" class="header-anchor">#</a> Node Module</h2> <h3 id="模块化作用"><a href="#模块化作用" aria-hidden="true" class="header-anchor">#</a> 模块化作用</h3> <ul><li>解决协同开发问题，避免全局变量，防止重名。</li></ul> <h3 id="node模块化类型"><a href="#node模块化类型" aria-hidden="true" class="header-anchor">#</a> node模块化类型</h3> <ul><li>common.js</li> <li>模块化所有类型
<ul><li>cmd:如sea.js</li> <li>amd:如require.js</li></ul></li></ul> <h3 id="定义模块"><a href="#定义模块" aria-hidden="true" class="header-anchor">#</a> 定义模块</h3> <ul><li>node中一个文件就是一个模块</li></ul> <h3 id="引用模块"><a href="#引用模块" aria-hidden="true" class="header-anchor">#</a> 引用模块</h3> <ul><li>require静态导入，</li></ul> <div class="warning custom-block"><p class="custom-block-title">注意：</p> <ul><li>esmodule（es6模块）,使用import动态导入</li> <li>node靠静态文件读取</li></ul></div> <h3 id="导出模块"><a href="#导出模块" aria-hidden="true" class="header-anchor">#</a> 导出模块</h3> <ul><li>module.exports</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//1.js</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token string">&quot;zfpx&quot;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//2.module.js</span>
<span class="token comment">//读取文件(会默认添加后缀名.js，找不到再.json，找不到再.node)</span>
<span class="token keyword">let</span> str<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./1.js'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> r<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./user'</span><span class="token punctuation">)</span>
<span class="token comment">//内置模块</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">注意</p> <ul><li>es6 export default/export</li> <li>node(es5) module.exports</li></ul></div> <h3 id="模块化原理-闭包"><a href="#模块化原理-闭包" aria-hidden="true" class="header-anchor">#</a> 模块化原理--闭包</h3> <ul><li>seajs、requirejs都是闭包，node也是为了模块化，所以在每个文件外面套了个闭包，这个函数把文件中的<code>this</code>指向更改为<code>module.exports</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span>require<span class="token punctuation">,</span>module<span class="token punctuation">,</span>__filename<span class="token punctuation">,</span>__dirname</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token string">'zfpx'</span><span class="token punctuation">;</span>
  <span class="token comment">//隐藏了这句</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> fn<span class="token operator">=</span><span class="token template-string"><span class="token string">`(function a(){let b=1;console.log(b)})()`</span></span><span class="token punctuation">;</span>
<span class="token comment">//内置模块 沙箱</span>
<span class="token keyword">let</span> vm<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="require原理-加载js如何实现"><a href="#require原理-加载js如何实现" aria-hidden="true" class="header-anchor">#</a> require原理(加载js如何实现)</h3> <ul><li>拿到用户传入的路径将路径解析成绝对路径，创建一个模块，根据路径加载对应的方法，如果是json把读取的结果放到模块的exports对象上，req方法最后返回这个exports对象</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//核心模块 不需要./操作</span>
<span class="token keyword">let</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vm<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token operator">=</span>id<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//导出对象</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> obj<span class="token operator">=</span><span class="token punctuation">{</span>
  <span class="token string">'.js'</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> content<span class="token operator">=</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> moduleWrap<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'(function(exports,module,require,__filename,__dirname){'</span><span class="token punctuation">,</span><span class="token string">'})'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//给字符串添加了一个函数</span>
    <span class="token keyword">let</span> script<span class="token operator">=</span>moduleWrap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>content<span class="token operator">+</span>moduleWrap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>module<span class="token punctuation">,</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'.json'</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//处理json的模块</span>
    module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">req</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//拿到绝对路径</span>
  <span class="token keyword">let</span> absPath<span class="token operator">=</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建模块</span>
  <span class="token keyword">let</span> module<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>absPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//根据后缀名进行加载</span>
  <span class="token keyword">let</span> ext<span class="token operator">=</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>absPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//加载json 加载完后expots会赋予最终的结果，并把结果返回</span>
  obj<span class="token punctuation">[</span>ext<span class="token punctuation">]</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> user<span class="token operator">=</span><span class="token function">req</span><span class="token punctuation">(</span><span class="token string">'./user.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> user<span class="token operator">=</span><span class="token function">req</span><span class="token punctuation">(</span><span class="token string">'./user.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">面试题</p> <p>module和exports什么关系？</p> <ul><li>exports是module.exports的别名</li></ul></div> <h3 id="module-exports的两种写法"><a href="#module-exports的两种写法" aria-hidden="true" class="header-anchor">#</a> module.exports的两种写法</h3> <ul><li>module.exports=xxx</li> <li>export.a=xxx</li> <li>global.b=xxx//引用时也是global.b//不推荐，一般不使用
exports=module.exports={}</li></ul> <p>所以不能直接赋值exports，因为返回的是module.exports，但可以赋值给exports.a属性值也会添加到module.exports身上</p> <h2 id="node内置方法"><a href="#node内置方法" aria-hidden="true" class="header-anchor">#</a> node内置方法</h2> <h3 id="vm沙箱"><a href="#vm沙箱" aria-hidden="true" class="header-anchor">#</a> vm沙箱</h3> <ul><li>vm.runInThisContext(fn) 在当前沙箱中运行fn代码</li></ul> <h3 id="fs沙箱"><a href="#fs沙箱" aria-hidden="true" class="header-anchor">#</a> fs沙箱</h3> <ul><li>fs.accessSync(文件名) 判断文件是否可以访问的到</li> <li>Fs.readfile() 读取文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span><span class="token string">'1.test.js'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="path-相对路径转绝对路径"><a href="#path-相对路径转绝对路径" aria-hidden="true" class="header-anchor">#</a> path 相对路径转绝对路径</h3> <ul><li>path.resolve(目录,文件名)在目录下找文件</li> <li>path.join(目录,文件名)拼接，与resolve唯一不同处在遇到/的时候，resolve会返回最上层目录</li> <li>path.extname('1.min.js') //取扩展名 .js</li> <li>path.basename('1.min.js','.js')//取基础名 1.min</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'1.test.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//C:\Users\speedly\...</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'1.test.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//__dirname下的1.test.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'1.test.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//与上面一样</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//resolve一碰到/就会返回最上层目录	c:\</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//a/</span>
path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'1.min.js'</span><span class="token punctuation">,</span><span class="token string">'.min.js'</span><span class="token punctuation">)</span><span class="token comment">//取基础名 1</span>
</code></pre></div><h3 id="util工具方法"><a href="#util工具方法" aria-hidden="true" class="header-anchor">#</a> util工具方法</h3> <ul><li>util.promisify(xxx)
<ul><li>将回调方法改成promise（util较麻烦，一般用第三方模块mz，将node模块转化成promise形式）</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//拿出来是个属性实例</span>
<span class="token keyword">let</span> util<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> read<span class="token operator">=</span>util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>Util.inherits();
<ul><li>继承方法，构造函数，继承原型上的公有属性(原理<code>Object.setPrototypefOf()</code>)</li></ul></li></ul> <h3 id="events-自定义事件"><a href="#events-自定义事件" aria-hidden="true" class="header-anchor">#</a> events 自定义事件</h3> <ul><li>node主要靠事件驱动(发布订阅模式，vue，redux都是)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//绑定</span>
girl<span class="token punctuation">.</span>on
<span class="token comment">//调用</span>
girl<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'失恋'</span><span class="token punctuation">)</span>
<span class="token comment">//新增绑定后调用,type是当前事件名称</span>
girl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'newListener'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//解除绑定</span>
girl<span class="token punctuation">.</span>removeListener<span class="token operator">/</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">'失恋'</span><span class="token punctuation">,</span>cry<span class="token punctuation">)</span>
<span class="token comment">//默认最大绑定数</span>
girl<span class="token punctuation">.</span>defaultMaxListeners
<span class="token comment">//设置最大绑定数</span>
girl<span class="token punctuation">.</span><span class="token function">setMaxListener</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">//不管绑定多少次，仅触发一次</span>
girl<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'失恋'</span><span class="token punctuation">,</span>cry<span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//拿出来是个类</span>
<span class="token keyword">let</span> EventEmitter<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> util<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Girl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  
<span class="token punctuation">}</span>
util<span class="token punctuation">.</span><span class="token function">inherits</span><span class="token punctuation">(</span>Girl<span class="token punctuation">,</span>EventEmitter<span class="token punctuation">)</span><span class="token punctuation">;</span>
girl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'newListener'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
  girl<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'失恋'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token function-variable function">cry</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'cry'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> <span class="token function-variable function">eat</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'eat'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
girl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'失恋'</span><span class="token punctuation">,</span>cry<span class="token punctuation">)</span><span class="token punctuation">;</span>
girl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'失恋'</span><span class="token punctuation">,</span>eat<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>events自定义事件原理</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token operator">=</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">prependListener</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>callback<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">on</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>callback<span class="token punctuation">,</span>flag</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token operator">=</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>eventName<span class="token operator">!=</span><span class="token string">'newListener'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>newListener<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>eventName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>falg<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">off</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">//当前函数绑定的是cry,删除的也是cry</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">l</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>l<span class="token operator">!=</span>callback<span class="token operator">&amp;&amp;</span>l<span class="token punctuation">.</span>l<span class="token operator">!=</span>callback<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">once</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token keyword">function</span> <span class="token function">one</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>one<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
one<span class="token punctuation">.</span>l<span class="token operator">=</span>callback<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Emitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">emit</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span>EventEmitter<span class="token punctuation">;</span>
</code></pre></div><h3 id="fs-文件"><a href="#fs-文件" aria-hidden="true" class="header-anchor">#</a> fs 文件</h3> <h4 id="编码"><a href="#编码" aria-hidden="true" class="header-anchor">#</a> 编码</h4> <ul><li>编码概况
<ul><li>node为了能操作文件，提供了fs模块，(文件内容一般都是二进制，八进制，十六进制），node读取的结果默认为十六进制</li> <li>一个字节最大是255位 0xff，</li> <li>汉字和字母占字节数</li></ul></li> <li>看编码
<ul><li>utf8 三个字节 1个字节</li></ul></li> <li>编码历史
<ol><li>ASCll码，最早美国人发明，包括127位英文字母在内的各种字符，所以一个英文字母占一位。但是对汉字和其他语言无效。</li> <li>GB2312，其他国家把128-255改成他们的字符，中国也改成了自己的字符，规定两个大于127的字符连一起就表示一个汉字，可以组合出7998个简体汉字，把数字符号，日文假名和ASCll原来就有的数字、标点、字母重编成两个字长的编码叫做全角字符。这种方案叫GB2312，是对ASCll的中文扩展。后来因为我们也得用法语，德语等其他语言，所以不用了。</li> <li>GBK，因为GB2312不够用，规定只要第二个字符大于127就是汉字，增加了20000个新汉字，包括繁体字和符号。</li> <li>GB18030/DBCS 增加了少数名字的字。</li> <li>Unicode，包括了地球上所有文化，所有字母和符号的编码，现在的规模可以容纳100多万个符号。规定所有的字母和符号都是两个字节。</li> <li>UTF-8，是Unicode的实现方式之一，是在互联网上使用最广的一种，意思是每次以8个单位传输数据，UTF-16就是以每次16位传输数据，UTF-8一个中文字符占3个字节。(node不支持gbk)</li></ol></li> <li>编码转换(base64)
<ol><li>图片转base64，不会发生请求</li> <li>简单的编码转换，没有加密功能，把原有体积扩大了1/3</li> <li><code>fileReader</code>文件读取器，读成<code>base64</code>编码的</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onchange</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>fn(event)<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> reader<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul> <h4 id="进制转换"><a href="#进制转换" aria-hidden="true" class="header-anchor">#</a> 进制转换</h4> <ul><li>().toString(进制)，任意进制转换</li> <li>parseInt('1011',2) 将任何进制转成十进制</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//十进制转化成二进制</span>
<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="buffer"><a href="#buffer" aria-hidden="true" class="header-anchor">#</a> Buffer</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> buf1<span class="token operator">=</span>Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> buf2<span class="token operator">=</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'珠峰'</span><span class="token punctuation">)</span>
<span class="token comment">//转字符串</span>
buf2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//珠峰</span>
<span class="token comment">//把数组和字符串转换成二进制</span>
buf1<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span>，<span class="token number">2</span>，<span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">//通过数字声明一个buffer，3是字节长度</span>
buf1<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment">//循环</span>
buf1<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//复制</span>
buf2<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>buf1<span class="token punctuation">,</span>targetStart<span class="token punctuation">,</span>sourceStart<span class="token punctuation">,</span>sourceEnd<span class="token punctuation">)</span>
<span class="token comment">//拼接</span>
Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>buf1<span class="token punctuation">,</span>buf2<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">//查找</span>
buf2<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'珠'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="fs"><a href="#fs" aria-hidden="true" class="header-anchor">#</a> fs</h4> <ul><li><p>fs将文件读取成buffer。</p></li> <li><p>fs方法中，一般会有同步和异步两种方法，同步可以马上拿到返回结果，异步通过callback，只能error-first来获取错误。一般采用异步的方式。
<code>{encoding:'utf8',flag:'r'}</code></p></li> <li><p>flags:
| 符号 | 含义                                     |
| ---- | ---------------------------------------- |
| r    | 读文件，文件不存在报错                   |
| r+   | 读取并写入，文件不存在报错               |
| w    | 写入文件，不存在则创建，存在则清空       |
| w+   | 读取并写入文件，不存在则创建，存在则清空 |
| wx   | 排它写入文件                             |
| a    | 追加写入                                 |</p></li> <li><p>fs.readFile</p> <ul><li>读取文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./note.md'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//{encoding:'utf8',flags:'r'}</span>
</code></pre></div></li> <li><p>fs.writeFile</p> <ul><li>写入文件(写入时，文件不存在会创建文件，如有内容会清空内容)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'./note.md'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// readFile+writeFile实现拷贝功能（readfile将内容整个读取到内存中，再写入文件中。所以这种方式不可能读取比内存大的文件）</span>
<span class="token keyword">function</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span>target</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">copy</span><span class="token punctuation">(</span><span class="token string">'a.md'</span><span class="token punctuation">,</span><span class="token string">'b.md'</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>fs.appendFile</p> <ul><li>追加写入（里面使用flag:a）</li></ul></li> <li><p>fs.copyFile</p> <ul><li>拷贝文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">copyFile</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span>target<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>从指定位置开始读取文件</p> <ul><li><p>打开文件：fs.open('./1,txt','r',0600,<strong>function</strong>(err,fd){});</p></li> <li><p>读取文件：fs.read(fd, buffer, offset, length, position, callback((err, bytesRead, buffer)))</p></li> <li><p>写入文件：fs.write(fd, buffer[, offset[, length[, position]]], callback)</p></li></ul> <p>process.stdin 0</p> <p>process.stdout 1</p> <p>process.stderr 2</p> <p>0,1,2是标识符，node中默认会占用0,1,2十三个描述符，所以自定义fd的是从3开始数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*打开文件*/</span>
fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'a.md'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>fd</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token comment">//3,fd是标识符，每次打开会累加</span>
  <span class="token keyword">let</span> buffer<span class="token operator">=</span>Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//只能放三勺水</span>
  <span class="token comment">/*读取文件*/</span>
  <span class="token comment">//fd 文件描述符 buffer读取到哪里</span>
  <span class="token comment">//0 是从buffer的哪个位置读取</span>
  <span class="token comment">//3 读取的个数</span>
  <span class="token comment">//0 读取文件的位置</span>
  fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>bytesRead</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	<span class="token comment">//bytesRead 真实读取的字节数 &lt;Buffer 31 00 00&gt;</span>
    <span class="token comment">/*关闭文件*/</span>
    fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'关闭'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*打开文件*/</span>
fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'a.md'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>fd</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">let</span> buffer<span class="token operator">=</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token comment">/*写入文件*/</span>
	<span class="token comment">//fd 代表文件描述符</span>
	<span class="token comment">//0 代表把buffer的第几个位置开始写入</span>
	<span class="token comment">//2 代表写入的个数</span>
	<span class="token comment">//0 写到文件的哪个位置</span>
  fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>written</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入成功'</span><span class="token punctuation">)</span>
    fs<span class="token punctuation">.</span><span class="token function">fsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//最后应该调用此方法，更新内存，将文件写入到磁盘中。</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//实现一个拷贝，用fs.open fs.read fs.write实现拷贝文件的功能，控制读取速率，防止内存占用过多</span>
<span class="token comment">//第三个参数写Null，就会自动往后，不用自己计算位置</span>
<span class="token comment">//流的原理，发布订阅来简化</span>
<span class="token keyword">function</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span>target<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> BufferSize<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>rfd</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>wfd</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token keyword">let</span> buffer<span class="token operator">=</span>Buffer<span class="token punctuation">.</span><span class="token function">aloc</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>rfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">BUFFERSIZE</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>bytesRead</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>bytesRead<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>wfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>bytesRead<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>written</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          	fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>rfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
          	fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>wfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
              fs<span class="token punctuation">.</span><span class="token function">fsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    	<span class="token punctuation">}</span><span class="token punctuation">;</span>
    	<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">copy</span><span class="token punctuation">(</span><span class="token string">'a.md'</span><span class="token punctuation">,</span><span class="token string">'b.md'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'复制成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>direction</p> <ul><li>基本操作</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//创建目录(必须保证父级存在)</span>
fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span><span class="token string">'a/b'</span><span class="token punctuation">)</span> 或者fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span><span class="token string">'a/b/c'</span><span class="token punctuation">)</span>或者 fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span><span class="token string">'a\\b'</span><span class="token punctuation">)</span>双杠为了转义成\
fs<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//判断一个文件是否有权限访问</span>
fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token punctuation">,</span> mode<span class="token punctuation">]</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
<span class="token comment">//删除目录(必须保证目录中没有子文件和子文件夹，否则会出错)</span>
fs<span class="token punctuation">.</span><span class="token function">rmdirSync</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token comment">//删除文件</span>
fs<span class="token punctuation">.</span>unlinkSync
fs<span class="token punctuation">.</span>unlink
<span class="token comment">//读取目录下所有文件</span>
fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token punctuation">,</span> options<span class="token punctuation">]</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
<span class="token comment">//查看文件目录信息</span>
<span class="token keyword">let</span> stat<span class="token operator">=</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<span class="token keyword">let</span> stat<span class="token operator">=</span>fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span>callback<span class="token punctuation">)</span>
stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//是否是目录</span>
stat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//是否是目录</span>
</code></pre></div><ul><li>做一个创建任意目录的工具</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//同步,使用for循环</span>
<span class="token keyword">function</span> <span class="token function">mkdirSync</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> dirs<span class="token operator">=</span>p<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>dirs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	<span class="token keyword">let</span> currentPath<span class="token operator">=</span>dirs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token keyword">try</span><span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span>currentPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>currentPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">mkdirSync</span><span class="token punctuation">(</span><span class="token string">'m/q/d'</span><span class="token punctuation">)</span>

<span class="token comment">//异步，使用递归，next方法来帮助进行迭代操作</span>
<span class="token comment">//fs.access</span>
<span class="token keyword">function</span> <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> dirs<span class="token operator">=</span>p<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	<span class="token keyword">if</span><span class="token punctuation">(</span>index<span class="token operator">===</span>dirs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> currentPath<span class="token operator">=</span>dirs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">++</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>currentPath<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>currentPath<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//当前文件夹存在就继续迭代</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">'a/b/c'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'创建完成'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>同步先序深度优先删除目录</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">rmSync</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> stat <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> files<span class="token operator">=</span>fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            files
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>file <span class="token operator">=</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item<span class="token operator">=</span><span class="token function">rmSync</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fs<span class="token punctuation">.</span><span class="token function">rmdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'删除失败!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">rmSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>异步串行删除目录深度优先</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">rmAsyncSeries</span><span class="token punctuation">(</span><span class="token parameter">dir<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>stat<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>files<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
                    <span class="token keyword">let</span> paths <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>file <span class="token operator">=</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>index<span class="token operator">&gt;=</span>files<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> current<span class="token operator">=</span>paths<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token function">rmAsyncSeries</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">next</span><span class="token punctuation">(</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">rmAsyncSeries</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>err <span class="token operator">=</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//异步并行删除目录深度优先</span>
<span class="token keyword">function</span> <span class="token function">rmAsyncParallel</span><span class="token punctuation">(</span><span class="token parameter">dir<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>stat<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>files<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
                    <span class="token keyword">let</span> paths<span class="token operator">=</span>files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>file <span class="token operator">=</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>paths<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">function</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>i <span class="token operator">==</span> paths<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                      paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token operator">=&gt;</span><span class="token function">rmAsyncParallel</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>done<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">rmAsyncParallel</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>err <span class="token operator">=</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'cost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//异步删除非空目录(Promise版)</span>
<span class="token keyword">function</span> <span class="token function">rmPromise</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>stat<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>files<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
                    <span class="token keyword">let</span> paths <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>file <span class="token operator">=</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> promises <span class="token operator">=</span> paths<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token operator">=&gt;</span><span class="token function">rmPromise</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">rmPromise</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'删除成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//同步删除目录(广度优先) </span>
<span class="token keyword">function</span> <span class="token function">rmSync</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> arr<span class="token operator">=</span><span class="token punctuation">[</span>dir<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> current<span class="token operator">=</span>arr<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> stat<span class="token operator">=</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> dirs<span class="token operator">=</span>fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            arr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">...</span>arr<span class="token punctuation">,</span><span class="token operator">...</span>dirs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>d <span class="token operator">=</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> item<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>item <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> stat <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">rmdirSync</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//异步删除目录(广度优先)</span>
<span class="token keyword">function</span> <span class="token function">rmdirWideAsync</span><span class="token punctuation">(</span><span class="token parameter">dir<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> dirs<span class="token operator">=</span><span class="token punctuation">[</span>dir<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> current <span class="token operator">=</span> dirs<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>stat<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>rmdir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>rmdir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">!</span><span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> current<span class="token operator">=</span>dirs<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>stat<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>files<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">{</span>
                        dirs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">...</span>dirs<span class="token punctuation">,</span><span class="token operator">...</span>files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="流"><a href="#流" aria-hidden="true" class="header-anchor">#</a> 流</h3> <p>直接读取文件会占用内存。而流会从一个位置读到另一个位置，不关心内存大小。原理是封装了fs.read等。</p> <p>Node.js中<strong>四种基本的流类型</strong>：</p> <ul><li>可读流，可写流，可读写流(双工流)，读写过程中可修改和变换数据的Duplex流</li></ul> <ol><li><p>可读流</p> <ol><li><p>创建</p> <p>fs.createReadStream(path,[options]);</p></li></ol> <ul><li><p>path读取文件的路径</p></li> <li><p>options</p> <ul><li>flags打开文件要做的操作,默认为'r'</li> <li>encoding默认为null</li> <li>autoClose:默认true</li> <li>start开始读取的索引位置</li> <li>end结束读取的索引位置(包前包后)</li> <li><strong>highWaterMark</strong>每次读取缓存区默认的大小64kb</li></ul></li></ul> <div class="language- extra-class"><pre class="language-text"><code>var rs = fs.createReadStream(path,[options]);
</code></pre></div><ol start="2"><li><p>监听data事件</p> <div class="language- extra-class"><pre class="language-text"><code>rs.on('data', function (data) {
    console.log(data);
});
</code></pre></div></li> <li><p>监听end事件</p> <div class="language- extra-class"><pre class="language-text"><code>rs.on('end', function () {
    console.log('读取完成');
});
</code></pre></div><p>所有事件都是内部发布，外部on订阅。</p></li> <li><p>监听open事件</p> <div class="language- extra-class"><pre class="language-text"><code>rs.on('open', function () {
    console.log(err);
});
</code></pre></div></li> <li><p>监听close事件</p> <div class="language- extra-class"><pre class="language-text"><code>rs.on('close', function () {
    console.log(err);
});
</code></pre></div></li> <li><p>监听错误事件(文件不存在)</p> <div class="language- extra-class"><pre class="language-text"><code>rs.on('error', function (err) {
    console.log(err);
});
</code></pre></div></li> <li><p>暂停和恢复触发data</p> <p>通过pause()方法和resume()方法</p> <div class="language- extra-class"><pre class="language-text"><code>rs.on('data', function (data) {
    rs.pause();
    console.log(data);
});
setTimeout(function () {
    rs.resume();
},2000);
</code></pre></div></li></ol></li> <li><p>可写流</p></li> <li><p>pipe方法</p></li> <li><p>简单实现原理</p></li> <li><p>暂停模式</p></li> <li><p>自定义可读流</p></li></ol> <h2 id="第三方模块"><a href="#第三方模块" aria-hidden="true" class="header-anchor">#</a> 第三方模块</h2> <ul><li>下载别人的包来使用npm（npm.js.org）</li> <li>安装方式：
<ul><li>全局安装
<ul><li>npm install xxx -g 只能在命令行中使用，工具类的会用这种方式</li> <li>统一安装到 C:\Users\speedly\AppData\Roaming\npm\node_modules(并不是像node和npm一样配置到环境变量里，而是在npm目录下创建了快捷键，所以能直接使用)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>npm install nrm <span class="token operator">-</span>g<span class="token comment">//切换npm下载源</span>
sudo npm install nrm <span class="token operator">-</span><span class="token function">g</span><span class="token punctuation">(</span>mac版<span class="token punctuation">)</span>
nrm <span class="token operator">--</span>help<span class="token comment">//查看使用方法</span>
nrm ls <span class="token comment">//列出所有源</span>
npm 官方 cnpm 中国 taoboa 淘宝的
nrm use npm<span class="token comment">//切到npm</span>
npm install http<span class="token operator">-</span>server <span class="token operator">-</span>g<span class="token comment">//启动一个服务</span>
npm root <span class="token operator">-</span>g<span class="token comment">//查看全局安装的安装目录</span>
</code></pre></div></li> <li>本地安装<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 先初始化(node package manager)：</span>
npm init <span class="token operator">-</span>y
<span class="token comment">// 默认是项目依赖(上线开发都需要，install可简写成i)</span>
npm install jquery 
<span class="token comment">// 开发的时候使用，上线不用</span>
npm install @babel<span class="token operator">/</span>cli <span class="token operator">-</span><span class="token constant">D</span> 
<span class="token comment">// 选择版本</span>
npm install jquery@<span class="token number">2.1</span><span class="token number">.0</span>
<span class="token comment">// 卸载</span>
Npm uninstall jquery
<span class="token comment">// 查看</span>
npm info react
<span class="token comment">// yarn也是一个包管理工具 区别：比npm快</span>
npm install yarn <span class="token operator">-</span>g
yarn add jquery
yarn remove jquery
<span class="token comment">// 安装成开发依赖(与npm一样)</span>
yarn add jquery <span class="token operator">-</span><span class="token constant">D</span>
</code></pre></div></li></ul></li></ul> <h3 id="mz模块"><a href="#mz模块" aria-hidden="true" class="header-anchor">#</a> mz模块</h3> <ul><li>将回调方法改成promise</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mz/fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="websocket"><a href="#websocket" aria-hidden="true" class="header-anchor">#</a> websocket</h3> <ul><li>安装</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>npm i nodejs<span class="token operator">-</span>websocket <span class="token operator">-</span><span class="token constant">S</span>
</code></pre></div><ul><li>创建服务使用</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> ws <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;nodejs-websocket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始建立连接...&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> server <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">conn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  conn<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span>
        text<span class="token punctuation">:</span> <span class="token string">&quot;something&quot;</span><span class="token punctuation">,</span>
        id<span class="token punctuation">:</span>   <span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span>
        date<span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;message:&quot;</span><span class="token operator">+</span>str<span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  conn<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;关闭连接&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  conn<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;异常关闭&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;WebSocket建立完毕&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="模块查找流程"><a href="#模块查找流程" aria-hidden="true" class="header-anchor">#</a> 模块查找流程</h2> <p><img src="/img/commonjs%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE%E9%80%BB%E8%BE%91%E5%9B%BE" alt="commonjs文件查找逻辑图"></p> <ul><li>当前node_modules下，如果有文件同名js，先走js，找不到再找index.js，</li> <li>有文件先找文件，没有文件再找文件夹//node10以上</li> <li>自己写的模块也一样。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// comsole.log(module.paths) </span>
<span class="token comment">// 模块的所有路径，当前路径找不到，就往上找</span>
<span class="token punctuation">[</span> <span class="token string">'/Users/yinyi/test/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/Users/yinyi/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/Users/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/node_modules'</span> <span class="token punctuation">]</span>
</code></pre></div><p><strong>node核心模块</strong></p> <h2 id="express"><a href="#express" aria-hidden="true" class="header-anchor">#</a> express</h2> <ul><li>安装</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>npm install <span class="token operator">-</span>g express<span class="token operator">-</span>generator
npm install <span class="token operator">-</span>g express
</code></pre></div><ul><li>快速创建express项目</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// e.js作为模板引擎</span>
express <span class="token operator">-</span>e <span class="token punctuation">.</span><span class="token operator">/</span>
</code></pre></div><ul><li>使用</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//server.js</span>
<span class="token keyword">let</span> express<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> app<span class="token operator">=</span><span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/getUser'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'zfpx'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">8/5/2019, 6:05:36 AM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.50f8ab08.js" defer></script><script src="/assets/js/13.d2e67b08.js" defer></script>
  </body>
</html>
