<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>egg | NorthUnicorn</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.d4311df0.css" as="style"><link rel="preload" href="/assets/js/app.c4cf2eda.js" as="script"><link rel="preload" href="/assets/js/10.6cd71b79.js" as="script"><link rel="prefetch" href="/assets/js/11.422b6fcc.js"><link rel="prefetch" href="/assets/js/12.98e6e0fd.js"><link rel="prefetch" href="/assets/js/13.50517f5f.js"><link rel="prefetch" href="/assets/js/14.706f6f8f.js"><link rel="prefetch" href="/assets/js/15.6aeae412.js"><link rel="prefetch" href="/assets/js/16.6f9f8d7c.js"><link rel="prefetch" href="/assets/js/17.4a939374.js"><link rel="prefetch" href="/assets/js/18.8ca9d15a.js"><link rel="prefetch" href="/assets/js/19.0379ebaf.js"><link rel="prefetch" href="/assets/js/2.e27297f7.js"><link rel="prefetch" href="/assets/js/20.628ecc9a.js"><link rel="prefetch" href="/assets/js/21.00910530.js"><link rel="prefetch" href="/assets/js/22.2b1e5011.js"><link rel="prefetch" href="/assets/js/23.8097ecb2.js"><link rel="prefetch" href="/assets/js/24.f22c2e26.js"><link rel="prefetch" href="/assets/js/25.7f3808a6.js"><link rel="prefetch" href="/assets/js/26.99a7eac6.js"><link rel="prefetch" href="/assets/js/27.a13d7bf0.js"><link rel="prefetch" href="/assets/js/3.3d37efe5.js"><link rel="prefetch" href="/assets/js/4.2b055829.js"><link rel="prefetch" href="/assets/js/5.a49d4744.js"><link rel="prefetch" href="/assets/js/6.fbe1d0e6.js"><link rel="prefetch" href="/assets/js/7.b5e36c76.js"><link rel="prefetch" href="/assets/js/8.9a129d08.js"><link rel="prefetch" href="/assets/js/9.c45149f5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d4311df0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NorthUnicorn</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/qianduan/" class="nav-link">前端</a></div><div class="nav-item"><a href="/houduan/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/operation/" class="nav-link">运维</a></div><div class="nav-item"><a href="/foundation/" class="nav-link">内功</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/qianduan/" class="nav-link">前端</a></div><div class="nav-item"><a href="/houduan/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/operation/" class="nav-link">运维</a></div><div class="nav-item"><a href="/foundation/" class="nav-link">内功</a></div><div class="nav-item"><a href="https://github.com/xiaoqi7777" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>后端基础汇总</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/houduan/node.html" class="sidebar-link">node</a></li><li><a href="/houduan/ios.html" class="sidebar-link">ISO</a></li><li><a href="/houduan/mongodb.html" class="sidebar-link">MongoDB</a></li><li><a href="/houduan/egg.html" class="active sidebar-link">egg</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/houduan/egg.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#配置启动脚本" class="sidebar-link">配置启动脚本</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#跑通路由-目录结构" class="sidebar-link">跑通路由(目录结构)</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#配置路由" class="sidebar-link">配置路由</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#编写控制器" class="sidebar-link">编写控制器</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#编写配置文件" class="sidebar-link">编写配置文件</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#静态文件中间件" class="sidebar-link">静态文件中间件</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#使用模板引擎" class="sidebar-link">使用模板引擎</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#读取远程接口服务" class="sidebar-link">读取远程接口服务</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#扩展工具方法" class="sidebar-link">扩展工具方法</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#中间件" class="sidebar-link">中间件</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#运行环境" class="sidebar-link">运行环境</a></li><li class="sidebar-sub-header"><a href="/houduan/egg.html#单元测试" class="sidebar-link">单元测试</a></li></ul></li><li><a href="/houduan/mock.html" class="sidebar-link">Mockjs</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="egg"><a href="#egg" aria-hidden="true" class="header-anchor">#</a> egg</h1> <p></p><div class="table-of-contents"><ul><li><a href="#安装">安装</a></li><li><a href="#配置启动脚本">配置启动脚本</a></li><li><a href="#跑通路由-目录结构">跑通路由(目录结构)</a></li><li><a href="#配置路由">配置路由</a></li><li><a href="#编写控制器">编写控制器</a></li><li><a href="#编写配置文件">编写配置文件</a></li><li><a href="#静态文件中间件">静态文件中间件</a></li><li><a href="#使用模板引擎">使用模板引擎</a></li><li><a href="#读取远程接口服务">读取远程接口服务</a></li><li><a href="#扩展工具方法">扩展工具方法</a></li><li><a href="#中间件">中间件</a></li><li><a href="#运行环境">运行环境</a></li><li><a href="#单元测试">单元测试</a><ul><li><a href="#mock">mock</a></li><li><a href="#app">app</a></li><li><a href="#钩子函数">钩子函数</a></li><li><a href="#ctx">ctx</a></li><li><a href="#异步测试">异步测试</a></li><li><a href="#controller">Controller</a></li><li><a href="#准备数据">准备数据</a></li><li><a href="#user-test-js">user.test.js</a></li><li><a href="#service">service</a></li><li><a href="#extend-测试">Extend 测试</a></li><li><a href="#context">context</a></li><li><a href="#request">Request</a></li><li><a href="#response">response</a></li><li><a href="#helper">Helper</a></li></ul></li></ul></div><p></p> <div class="tip custom-block"><p class="custom-block-title">egg.js 流程</p> <p>client =&gt; controller =&gt; server =&gt; mysql
mysql =&gt; server =&gt; controller =&gt; cliect</p></div> <h2 id="安装"><a href="#安装" aria-hidden="true" class="header-anchor">#</a> 安装</h2> <ul><li>cnpm i egg --save 上线用</li> <li>cnpm i egg-bin --save-dev  开发用</li></ul> <h2 id="配置启动脚本"><a href="#配置启动脚本" aria-hidden="true" class="header-anchor">#</a> 配置启动脚本</h2> <ul><li>&quot;dev&quot;:&quot;egg-bin dev&quot;</li></ul> <h2 id="跑通路由-目录结构"><a href="#跑通路由-目录结构" aria-hidden="true" class="header-anchor">#</a> 跑通路由(目录结构)</h2> <div class="language-js extra-class"><pre class="language-js"><code>      ├─app
      │  │─router<span class="token punctuation">.</span>js
      │  ├─controller
      │  │      news<span class="token punctuation">.</span>js
      ├─config
      │      config<span class="token punctuation">.</span>default<span class="token punctuation">.</span>js
      <span class="token operator">|</span>─<span class="token keyword">package</span><span class="token punctuation">.</span>json
</code></pre></div><h2 id="配置路由"><a href="#配置路由" aria-hidden="true" class="header-anchor">#</a> 配置路由</h2> <div class="language-js extra-class"><pre class="language-js"><code>  app<span class="token operator">/</span>router<span class="token punctuation">.</span>js
    module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
        router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/news'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="编写控制器"><a href="#编写控制器" aria-hidden="true" class="header-anchor">#</a> 编写控制器</h2> <div class="language-js extra-class"><pre class="language-js"><code>app\controller\news<span class="token punctuation">.</span>js
  <span class="token keyword">const</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
      <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
          <span class="token comment">// ctx.body 是响应体的对象</span>
          <span class="token comment">// ctx.text 是响应体的文本</span>
          <span class="token comment">// ctx.render 渲染</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NewsController<span class="token punctuation">;</span>
</code></pre></div><h2 id="编写配置文件"><a href="#编写配置文件" aria-hidden="true" class="header-anchor">#</a> 编写配置文件</h2> <div class="language-js extra-class"><pre class="language-js"><code>  exports<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token string">'zfpx'</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>访问
<table><thead><tr><th>文件</th> <th>app</th> <th>ctx</th> <th>service</th> <th>config</th> <th>logger</th> <th>helper</th></tr></thead> <tbody><tr><td>Controller</td> <td>this.app</td> <td>this.ctx</td> <td>this.service</td> <td>this.config</td> <td>this.logger</td> <td>this.app.helper</td></tr> <tr><td>Service</td> <td>this.app</td> <td>this.ctx</td> <td>this.service</td> <td>this.config</td> <td>this.logger</td> <td>this.app.helper</td></tr></tbody></table></li></ul> <h2 id="静态文件中间件"><a href="#静态文件中间件" aria-hidden="true" class="header-anchor">#</a> 静态文件中间件</h2> <ul><li>Egg 内置了 static 插件</li> <li>static 插件默认映射 /public/ -&gt; app/public/ 目录</li> <li>把静态资源都放到 app/public 目录即可</li></ul> <h2 id="使用模板引擎"><a href="#使用模板引擎" aria-hidden="true" class="header-anchor">#</a> 使用模板引擎</h2> <div class="language-js extra-class"><pre class="language-js"><code>      ├─app
      │  │─router<span class="token punctuation">.</span>js
      │  ├─controller
      │  │      news<span class="token punctuation">.</span>js   
      │  ├─<span class="token keyword">public</span>
      │  │  ├─css
      │  │  │      bootstrap<span class="token punctuation">.</span>css  
      │  │  └─js
      │  │          bootstrap<span class="token punctuation">.</span>js         
      │  └─view
      │          news<span class="token punctuation">.</span>html       
      ├─config
      │   config<span class="token punctuation">.</span>default<span class="token punctuation">.</span>js
      │   plugin<span class="token punctuation">.</span>js
</code></pre></div><ul><li>egg-view-nunjucks 模板引擎</li></ul> <div class="language-js extra-class"><pre class="language-js"><code> cnpm install egg<span class="token operator">-</span>view<span class="token operator">-</span>nunjucks <span class="token operator">--</span>save
 
 启用插件
 <span class="token punctuation">{</span><span class="token constant">ROOT</span><span class="token punctuation">}</span>\config\plugin<span class="token punctuation">.</span>js
  exports<span class="token punctuation">.</span>nunjucks <span class="token operator">=</span> <span class="token punctuation">{</span>
      enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">'egg-view-nunjucks'</span>
  <span class="token punctuation">}</span>

  配置模板
  <span class="token punctuation">{</span><span class="token constant">ROOT</span><span class="token punctuation">}</span>\config\config<span class="token punctuation">.</span>default<span class="token punctuation">.</span>js
  module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>keys<span class="token operator">=</span><span class="token string">'zfpx'</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>view<span class="token operator">=</span><span class="token punctuation">{</span>
        defaultExtension<span class="token punctuation">:</span> <span class="token string">'.html'</span><span class="token punctuation">,</span>
        defaultViewEngine<span class="token punctuation">:</span> <span class="token string">'nunjucks'</span><span class="token punctuation">,</span>
        mapping<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'.html'</span><span class="token punctuation">:</span><span class="token string">'nunjucks'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> config<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  编写模板
  app\view\index<span class="token punctuation">.</span>html
  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;container&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;row&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;col-md-8 col-md-offset-2&quot;</span><span class="token operator">&gt;</span>
          <span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> list<span class="token operator">%</span><span class="token punctuation">}</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;panel panel-default&quot;</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;panel-heading&quot;</span><span class="token operator">&gt;</span>
                      <span class="token operator">&lt;</span>h3 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;text-center&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;panel-body&quot;</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;{{item.image}}&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;img-responsive center-block&quot;</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;panel-footer&quot;</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>h3<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>createAt<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

  编写控制器
  app\controller\news<span class="token punctuation">.</span>js
  <span class="token keyword">const</span> <span class="token punctuation">{</span>Controller<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">{</span>
      <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> list<span class="token operator">=</span><span class="token punctuation">[</span>
              <span class="token punctuation">{</span>
                  id<span class="token punctuation">:</span> <span class="token string">'45154322_0'</span><span class="token punctuation">,</span>
                  title<span class="token punctuation">:</span> <span class="token string">'世界首富早晚是这个人，坐拥7家独角兽公司，估值破数万！'</span><span class="token punctuation">,</span>
                  url<span class="token punctuation">:</span> <span class="token string">'http://tech.ifeng.com/a/20180904/45154322_0.shtml'</span><span class="token punctuation">,</span>
                  image<span class="token punctuation">:</span><span class="token string">'http://p0.ifengimg.com/pmop/2018/0905/CFFF918B94D561D2A61FB434ADA81589E8972025_size41_w640_h479.jpeg'</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                  id<span class="token punctuation">:</span> <span class="token string">'16491630_0'</span><span class="token punctuation">,</span>
                  title<span class="token punctuation">:</span> <span class="token string">'支付宝们来了！将来人民币会消失吗？'</span><span class="token punctuation">,</span>
                  url<span class="token punctuation">:</span> <span class="token string">'http://finance.ifeng.com/a/20180907/16491630_0.shtml'</span><span class="token punctuation">,</span>
                  image<span class="token punctuation">:</span><span class="token string">'http://p0.ifengimg.com/pmop/2018/0907/2AF684C2EC49B7E3C17FCB13D6DEEF08401D4567_size27_w530_h369.jpeg'</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                  id<span class="token punctuation">:</span> <span class="token string">'2451982'</span><span class="token punctuation">,</span>
                  title<span class="token punctuation">:</span> <span class="token string">'《福布斯》专访贝索斯：无业务边界的亚马逊 令对手生畏的CEO'</span><span class="token punctuation">,</span>
                  url<span class="token punctuation">:</span> <span class="token string">'https://www.jiemian.com/article/2451982.html'</span><span class="token punctuation">,</span>
                  image<span class="token punctuation">:</span><span class="token string">'https://img1.jiemian.com/101/original/20180907/153628523948814900_a580x330.jpg'</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>list<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  module<span class="token punctuation">.</span>exports<span class="token operator">=</span>NewsController<span class="token punctuation">;</span>
</code></pre></div><h2 id="读取远程接口服务"><a href="#读取远程接口服务" aria-hidden="true" class="header-anchor">#</a> 读取远程接口服务</h2> <ul><li>在实际应用中，Controller 一般不会自己产出数据，也不会包含复杂的逻辑，复杂的过程应抽象为业务逻辑层 Service</li> <li>添加配置</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>    config<span class="token punctuation">.</span>default<span class="token punctuation">.</span>js
    config<span class="token punctuation">.</span>news<span class="token operator">=</span><span class="token punctuation">{</span>
            newsListUrl<span class="token punctuation">:</span> <span class="token string">'https://xxx/news'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    编写Service 
      app<span class="token operator">/</span>service<span class="token operator">/</span>news<span class="token punctuation">.</span>js
      <span class="token keyword">const</span> <span class="token punctuation">{</span>Service<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">class</span> <span class="token class-name">NewsService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
          <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
              <span class="token keyword">const</span> <span class="token punctuation">{</span>newsListUrl<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>news<span class="token punctuation">;</span>
              <span class="token keyword">const</span> result<span class="token operator">=</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>newsListUrl<span class="token punctuation">,</span><span class="token punctuation">{</span>
                  method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
                  dataType<span class="token punctuation">:</span><span class="token string">'json'</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      module<span class="token punctuation">.</span>exports<span class="token operator">=</span>NewsService<span class="token punctuation">;</span>

    编写控制层
      app<span class="token operator">/</span>controller<span class="token operator">/</span>news<span class="token punctuation">.</span>js
      <span class="token keyword">const</span> <span class="token punctuation">{</span>Controller<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">{</span>
          <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">,</span>service<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
              <span class="token keyword">const</span> list<span class="token operator">=</span><span class="token keyword">await</span> service<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>list<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      module<span class="token punctuation">.</span>exports<span class="token operator">=</span>NewsController<span class="token punctuation">;</span>
</code></pre></div><h2 id="扩展工具方法"><a href="#扩展工具方法" aria-hidden="true" class="header-anchor">#</a> 扩展工具方法</h2> <ul><li>框架提供了一种快速扩展的方式，只需在app/extend目录下提供扩展脚本即可</li> <li>Helper 函数用来提供一些实用的 utility 函数。</li> <li>访问方式 通过 ctx.helper 访问到 helper 对象</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  app\extend\helper<span class="token punctuation">.</span>js
    <span class="token keyword">const</span> moment<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'moment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    moment<span class="token punctuation">.</span><span class="token function">locale</span><span class="token punctuation">(</span><span class="token string">'zh-cn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span><span class="token function-variable function">fromNow</span><span class="token operator">=</span><span class="token parameter">dateTime</span> <span class="token operator">=&gt;</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>dateTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app\controller\news<span class="token punctuation">.</span>js
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span>createAt<span class="token operator">=</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">fromNow</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>createAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> item<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app\view\index<span class="token punctuation">.</span>html
    时间<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>helper<span class="token punctuation">.</span><span class="token function">fromNow</span><span class="token punctuation">(</span>news<span class="token punctuation">.</span>createAt<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="中间件"><a href="#中间件" aria-hidden="true" class="header-anchor">#</a> 中间件</h2> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 进路由之前 都会先走中间件</span>
  app<span class="token operator">/</span>middleware<span class="token operator">/</span>robot<span class="token punctuation">.</span>js
    module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span>app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// options 对应 config.robot</span>
        <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// user-agent 获取浏览器的信息</span>
            <span class="token keyword">const</span> source<span class="token operator">=</span>ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'user-agent'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">''</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> matched<span class="token operator">=</span>options<span class="token punctuation">.</span>ua<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">ua</span> <span class="token operator">=&gt;</span> ua<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span>status<span class="token operator">=</span><span class="token number">403</span><span class="token punctuation">;</span>
                ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">'你没有访问权限'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
  config<span class="token punctuation">.</span>default<span class="token punctuation">.</span>js
    config<span class="token punctuation">.</span>middleware<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token string">'robot'</span>
    <span class="token punctuation">]</span>
    config<span class="token punctuation">.</span>robot<span class="token operator">=</span><span class="token punctuation">{</span>
        ua<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token regex">/Chrome/</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="运行环境"><a href="#运行环境" aria-hidden="true" class="header-anchor">#</a> 运行环境</h2> <ul><li>框架有两种方式指定运行环境：
<ul><li>通过 config/env 文件指定，该文件的内容就是运行环境，如 prod。</li> <li>通过 EGG_SERVER_ENV 环境变量指定。</li> <li>框架提供了变量 app.config.env 来表示应用当前的运行环境。</li> <li>支持按环境变量加载不同的配置文件，如 config.local.js， config.prod.js 等等</li></ul></li></ul> <table><thead><tr><th>EGG_SERVER_ENV</th> <th>说明</th></tr></thead> <tbody><tr><td>local</td> <td>本地开发环境</td></tr> <tr><td>prod</td> <td>生产环境</td></tr></tbody></table> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// cross-env 可以兼容windows和mac</span>
  npm install  cross<span class="token operator">-</span>env <span class="token operator">--</span>save<span class="token operator">-</span>dev

  <span class="token string">&quot;scripts&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;dev&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;cross-env EGG_SERVER_ENV=local  egg-bin dev&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;debug&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;egg-bin debug&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="单元测试"><a href="#单元测试" aria-hidden="true" class="header-anchor">#</a> 单元测试</h2> <ul><li>power-assert 断言 (egg都内置了)</li> <li>mochajs 测试</li> <li>测试目录
<ul><li>约定test 目录为存放目录</li> <li>测试脚本文件统一按 ${filename}.test.js 命名，必须以 .test.js 作为文件后缀。 一个应用的测试目录示例：</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  test
  ├── controller
  │   └── news<span class="token punctuation">.</span>test<span class="token punctuation">.</span>js
  └── service
    └── news<span class="token punctuation">.</span>test<span class="token punctuation">.</span>js
</code></pre></div><ul><li>测试运行工具</li> <li>统一使用 egg-bin 来运行测试脚本， 自动将内置的 Mocha、co-mocha、power-assert，nyc 等模块组合引入到测试脚本中， 让我们聚焦精力在编写测试代码上，而不是纠结选择那些测试周边工具和模块。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token string">&quot;scripts&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;test&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;egg-bin test&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;cov&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;egg-bin cov&quot;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="mock"><a href="#mock" aria-hidden="true" class="header-anchor">#</a> mock</h3> <ul><li>egg.js单独为框架抽取了一个测试 mock 辅助模块：egg-mock， 有了它我们就可以非常快速地编写一个 app 的单元测试，并且还能快速创建一个 ctx 来测试它的属性、方法和 Service 等。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  cnpm i egg<span class="token operator">-</span>mock <span class="token operator">-</span><span class="token constant">D</span>
</code></pre></div><h3 id="app"><a href="#app" aria-hidden="true" class="header-anchor">#</a> app</h3> <ul><li>在测试运行之前，我们首先要创建应用的一个 app 实例， 通过它来访问需要被测试的 Controller、Middleware、Service 等应用层代码。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// test/controller/home.test.js</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock/bootstrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/news.test.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="钩子函数"><a href="#钩子函数" aria-hidden="true" class="header-anchor">#</a> 钩子函数</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'egg test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'order 1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'order 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'order 6'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'order 3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'order 5'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should worker'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'order 4'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="ctx"><a href="#ctx" aria-hidden="true" class="header-anchor">#</a> ctx</h3> <ul><li>test/controller/news.test.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock/bootstrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/news.test.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should get a ctx'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> ctx<span class="token operator">=</span>app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              session<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                user<span class="token punctuation">:</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'zfpx'</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>url<span class="token operator">===</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'zfpx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="异步测试"><a href="#异步测试" aria-hidden="true" class="header-anchor">#</a> 异步测试</h3> <ul><li>test/controller/news.test.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">//egg-bin 支持测试异步调用，它支持多种写法</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'promise'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/news'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'callback'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/news'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'async'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/news'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="controller"><a href="#controller" aria-hidden="true" class="header-anchor">#</a> Controller</h3> <ul><li>test/controller/user.test.js</li> <li>app.httpRequest()是 egg-mock 封装的 SuperTest 请求实例</li></ul> <h3 id="准备数据"><a href="#准备数据" aria-hidden="true" class="header-anchor">#</a> 准备数据</h3> <ul><li>app/router.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/doAdd'</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>doAdd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>app/controller/user.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> <span class="token punctuation">{</span>Controller<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> users<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">{</span>
        <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'user/list'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>users<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">async</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'user/add'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">async</span> <span class="token function">doAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> user<span class="token operator">=</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
            user<span class="token punctuation">.</span>id<span class="token operator">=</span>users<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">?</span>users<span class="token punctuation">[</span>users<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">;</span>
            users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    module<span class="token punctuation">.</span>exports<span class="token operator">=</span>UserController<span class="token punctuation">;</span>
</code></pre></div><h3 id="user-test-js"><a href="#user-test-js" aria-hidden="true" class="header-anchor">#</a> user.test.js</h3> <ul><li>test/controller/user.test.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock/bootstrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'test post'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> user<span class="token operator">=</span><span class="token punctuation">{</span>username<span class="token punctuation">:</span> <span class="token string">'zfpx'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      app<span class="token punctuation">.</span><span class="token function">mockCsrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> response<span class="token operator">=</span><span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/doAdd'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="service"><a href="#service" aria-hidden="true" class="header-anchor">#</a> service</h3> <ul><li>Service 相对于 Controller 来说，测试起来会更加简单</li> <li>我们只需要先创建一个 ctx，然后通过 ctx.service.${serviceName} 拿到 Service 实例， 然后调用 Service 方法即可。</li> <li>test/service/user.test.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock/bootstrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>app<span class="token punctuation">,</span>assert<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock/bootstrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/service/news.test.js'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'newsService'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> ctx<span class="token operator">=</span>app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> result<span class="token operator">=</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">assert</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="extend-测试"><a href="#extend-测试" aria-hidden="true" class="header-anchor">#</a> Extend 测试</h3> <ul><li>应用可以对 Application、Request、Response、Context 和 Helper 进行扩展。 我们可以对扩展的方法或者属性针对性的编写单元测试。</li> <li>egg-mock 创建 app 的时候，已经将 Application 的扩展自动加载到 app 实例了， 直接使用这个 app 实例访问扩展的属性和方法即可进行测试。</li> <li>app/extend/application.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> cacheData<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  exports<span class="token punctuation">.</span>cache<span class="token operator">=</span><span class="token punctuation">{</span>
      <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> cacheData<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          cacheData<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>val<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>test/app/extend/cache.test.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock/bootstrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/app/extend/cache.test.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'cache'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'zfpx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">assert</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'zfpx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="context"><a href="#context" aria-hidden="true" class="header-anchor">#</a> context</h3> <ul><li>Context 测试只比 Application 多了一个 app.mockContext() 步骤来模拟创建一个 Context 对象。</li> <li>app\extend\context.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  exports<span class="token punctuation">.</span><span class="token function-variable function">language</span><span class="token operator">=</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'accept-language'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>test/app/extend/context.test.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock/bootstrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/app/extend/context.test.js'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> language<span class="token operator">=</span><span class="token string">&quot;zh-cn&quot;</span><span class="token punctuation">;</span>
      <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'test language'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> ctx<span class="token operator">=</span>app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span>headers<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'Accept-Language'</span><span class="token punctuation">:</span>language<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//console.log('ctx.lan',ctx.lan())</span>
          <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">language</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="request"><a href="#request" aria-hidden="true" class="header-anchor">#</a> Request</h3> <ul><li>通过 ctx.request 来访问 Request 扩展的属性和方法，直接即可进行测试。 app\extend\request.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
      <span class="token keyword">get</span> <span class="token function">isChrome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> userAgent<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'User-Agent'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> userAgent<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'chrome'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>test\extend\request.test.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock/bootstrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/app/extend/request.test.js'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'cache'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> ctx<span class="token operator">=</span>app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                  <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'I love Chrome'</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>isChrome<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="response"><a href="#response" aria-hidden="true" class="header-anchor">#</a> response</h3> <ul><li>Response 测试与 Request 完全一致。 通过 ctx.response 来访问 Response 扩展的属性和方法，直接即可进行测试。</li> <li>app\extend\response.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>test\extend\response.test.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'isSuccess()'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should true'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>isSuccess <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should false'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>isSuccess <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="helper"><a href="#helper" aria-hidden="true" class="header-anchor">#</a> Helper</h3> <ul><li>Helper 测试方式与 Service 类似，也是通过 ctx 来访问到 Helper，然后调用 Helper 方法测试</li> <li>app\extend\helper.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">money</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> lang <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'accept-language'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>lang<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'zh-cn'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`￥ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`$ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>test\extend\helper.test.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'money()'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should RMB'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 模拟 ctx 的 headers</span>
        headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">'Accept-Language'</span><span class="token punctuation">:</span> <span class="token string">'zh-cn'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">money</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'￥ 100'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should US Dolar'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">money</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'$ 100'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/houduan/mongodb.html" class="prev">
          MongoDB
        </a></span> <span class="next"><a href="/houduan/mock.html">
          Mockjs
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.c4cf2eda.js" defer></script><script src="/assets/js/10.6cd71b79.js" defer></script>
  </body>
</html>
